<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스티커 메모 자동 닫힘 수정 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .debug-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .calendar-fake {
            width: 100%;
            height: 200px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #6c757d;
            margin: 20px 0;
            position: relative;
            z-index: 1;
        }
        
        /* 스티커 메모 스타일 (원본과 동일) */
        #stickyMemo {
            position: fixed !important;
            z-index: 2147483647 !important;
            display: none;
            visibility: visible !important;
            opacity: 1 !important;
            width: 350px;
            min-height: 400px;
            background: linear-gradient(135deg, rgba(255, 249, 196, 0.98) 0%, rgba(255, 245, 157, 0.98) 100%);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 120px rgba(255, 193, 7, 0.5);
            border: 1px solid rgba(255, 193, 7, 0.3);
            backdrop-filter: blur(20px) saturate(180%);
            pointer-events: auto;
            isolation: isolate;
            transform: translateZ(0);
            will-change: transform;
            contain: layout style paint;
        }
        
        .sticky-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px 10px;
            border-bottom: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .sticky-title {
            color: #b8860b;
            font-weight: bold;
            font-size: 18px;
        }
        
        .sticky-control-btn {
            background: none;
            border: none;
            color: #b8860b;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }
        
        .sticky-control-btn:hover {
            background: rgba(255, 193, 7, 0.2);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🛡️ 스티커 메모 자동 닫힘 수정 테스트</h1>
        
        <div class="calendar-fake" id="calendar">
            가짜 달력 (z-index: 1)
        </div>
        
        <div>
            <button class="test-button" onclick="testOpenStickyMemo()">🎯 스티커 메모 열기</button>
            <button class="test-button" onclick="testForceClose()">🔴 강제 닫기</button>
            <button class="debug-button" onclick="debugAutoClose()">🔧 디버그</button>
            <button class="debug-button" onclick="clearLog()">🗑️ 로그 지우기</button>
        </div>
        
        <div>
            <h3>📊 테스트 시나리오</h3>
            <button class="debug-button" onclick="testScenario1()">시나리오 1: 정상 열기</button>
            <button class="debug-button" onclick="testScenario2()">시나리오 2: 빠른 재열기</button>
            <button class="debug-button" onclick="testScenario3()">시나리오 3: 자동 닫힘 테스트</button>
        </div>
        
        <div class="log" id="testLog"></div>
    </div>
    
    <!-- 스티커 메모 HTML -->
    <div id="stickyMemo">
        <div class="sticky-header">
            <div class="sticky-title">📝 스티커 메모</div>
            <button class="sticky-control-btn sticky-close" id="stickyClose" title="닫기">✕</button>
        </div>
        <div style="padding: 20px;">
            <textarea style="width: 100%; height: 300px; border: none; background: transparent; resize: none; outline: none; font-size: 14px;" 
                placeholder="메모를 입력하세요..."></textarea>
        </div>
    </div>
    
    <!-- 필요한 스크립트들 로드 -->
    <script src="sticky-auto-close-fix.js"></script>
    
    <script>
        // 로그 함수
        function log(message) {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        // 기본 스티커 메모 함수들 구현
        window.openStickyMemo = function() {
            log('🎯 openStickyMemo 실행');
            const stickyMemo = document.getElementById('stickyMemo');
            
            if (!stickyMemo) {
                log('❌ 스티커 메모 요소를 찾을 수 없음');
                return;
            }
            
            // 위치 설정 (화면 중앙)
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const left = Math.max(50, (windowWidth - 350) / 2);
            const top = Math.max(50, (windowHeight - 400) / 3);
            
            stickyMemo.style.left = left + 'px';
            stickyMemo.style.top = top + 'px';
            
            // 표시
            stickyMemo.style.display = 'flex';
            
            log('✅ 스티커 메모 열기 완료');
            
            // 자동 닫힘 시뮬레이션 (원래 문제 재현용)
            if (window.autoCloseSimulation) {
                setTimeout(() => {
                    log('⚠️ 자동 닫힘 시뮬레이션 실행');
                    if (window.closeStickyMemo) {
                        window.closeStickyMemo();
                    }
                }, 1000);
            }
        };
        
        window.closeStickyMemo = function() {
            log('🔴 closeStickyMemo 실행');
            const stickyMemo = document.getElementById('stickyMemo');
            
            if (stickyMemo) {
                stickyMemo.style.display = 'none';
                log('❌ 스티커 메모 닫힘');
            }
        };
        
        // 테스트 함수들
        function testOpenStickyMemo() {
            log('📋 테스트: 스티커 메모 열기');
            window.openStickyMemo();
        }
        
        function testForceClose() {
            log('📋 테스트: 강제 닫기');
            if (window.forceCloseStickyMemo) {
                window.forceCloseStickyMemo();
            } else {
                window.closeStickyMemo();
            }
        }
        
        // 테스트 시나리오들
        function testScenario1() {
            log('🎬 시나리오 1: 정상 열기 테스트');
            window.autoCloseSimulation = false;
            
            setTimeout(() => {
                log('1. 스티커 메모 열기...');
                window.openStickyMemo();
            }, 100);
            
            setTimeout(() => {
                const stickyMemo = document.getElementById('stickyMemo');
                const isVisible = stickyMemo && stickyMemo.style.display !== 'none';
                log(`2. 결과 확인: ${isVisible ? '✅ 표시됨' : '❌ 숨겨짐'}`);
            }, 2000);
        }
        
        function testScenario2() {
            log('🎬 시나리오 2: 빠른 재열기 테스트');
            window.autoCloseSimulation = false;
            
            let step = 1;
            const interval = setInterval(() => {
                if (step <= 3) {
                    log(`${step}. 스티커 메모 열기...`);
                    window.openStickyMemo();
                    step++;
                } else {
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        const stickyMemo = document.getElementById('stickyMemo');
                        const isVisible = stickyMemo && stickyMemo.style.display !== 'none';
                        log(`4. 최종 결과: ${isVisible ? '✅ 안정적으로 표시됨' : '❌ 불안정함'}`);
                    }, 1000);
                }
            }, 500);
        }
        
        function testScenario3() {
            log('🎬 시나리오 3: 자동 닫힘 방지 테스트');
            window.autoCloseSimulation = true;
            
            setTimeout(() => {
                log('1. 자동 닫힘 시뮬레이션과 함께 스티커 메모 열기...');
                window.openStickyMemo();
            }, 100);
            
            setTimeout(() => {
                const stickyMemo = document.getElementById('stickyMemo');
                const isVisible = stickyMemo && stickyMemo.style.display !== 'none';
                log(`2. 1초 후 상태: ${isVisible ? '✅ 자동 닫힘 방지됨' : '❌ 자동 닫힘 발생'}`);
            }, 1500);
            
            setTimeout(() => {
                const stickyMemo = document.getElementById('stickyMemo');
                const isVisible = stickyMemo && stickyMemo.style.display !== 'none';
                log(`3. 3초 후 최종 상태: ${isVisible ? '✅ 지속적으로 표시됨' : '❌ 최종 닫힘'}`);
                window.autoCloseSimulation = false;
            }, 3500);
        }
        
        // 초기화 로그
        log('🎮 스티커 메모 자동 닫힘 수정 테스트 페이지 로드됨');
        log('🛡️ 자동 닫힘 방지 시스템이 로드되었는지 확인하세요');
        
        // 스티커 메모 기본 이벤트 설정
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.getElementById('stickyClose');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    log('🖱️ 닫기 버튼 클릭됨');
                    if (window.forceCloseStickyMemo) {
                        window.forceCloseStickyMemo();
                    } else {
                        window.closeStickyMemo();
                    }
                });
            }
        });
    </script>
</body>
</html>